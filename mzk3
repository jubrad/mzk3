#!/bin/bash
#
# Materialize Self-Managed Deployment Script for K3s
#
# This script installs and upgrades Materialize on a K3s Kubernetes cluster.
#
# Prerequisites:
#   - K3s cluster already running (https://k3s.io)
#   - kubectl configured to access the cluster
#   - Helm 3.x installed
#   - curl installed
#

set -e

# Default values (can be overridden by environment variables, then by flags)
DEFAULT_VERSION="v26.4.0"
VERSION="${MZ_VERSION:-$DEFAULT_VERSION}"
OPERATOR_VERSION="${MZ_OPERATOR_VERSION:-}"
LICENSE_KEY_FILE="${MZ_LICENSE_KEY:-}"
NAMESPACE="${MZ_NAMESPACE:-materialize}"
RELEASE_NAME="${MZ_RELEASE_NAME:-my-materialize-operator}"
INSTANCE_NS="${MZ_INSTANCE_NS:-materialize-environment}"
VALUES_FILE="${MZ_VALUES_FILE:-sample-values-k3s.yaml}"
SKIP_CONFIRM="${MZ_SKIP_CONFIRM:-false}"
K3D_CLUSTER_NAME="${K3D_CLUSTER_NAME:-mzk3-cluster}"
FORCE_ROLLOUT="false"
INSTALL_DASHBOARDS="${MZ_INSTALL_DASHBOARDS:-false}"
CREATE_CLUSTER="false"

# Label used to identify clusters created by this script
MZK3_LABEL="created-by=mzk3"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# Download file with validation
download_file() {
    local url="$1"
    local output="$2"
    curl -sfL -o "${output}" "${url}"
    if [[ ! -s "${output}" ]] || grep -q "^404:" "${output}" 2>/dev/null; then
        log_error "Failed to download: ${url}"
        rm -f "${output}"
        return 1
    fi
}

usage() {
    cat <<EOF
Usage: $(basename "$0") <command> [OPTIONS]

Deploy and manage Materialize on a K3s Kubernetes cluster.

Commands:
    install             Install Materialize (first-time setup)
    upgrade             Upgrade an existing Materialize installation
    create-cluster      Create a new k3d cluster for Materialize
    reset               Destroy and recreate the K3s cluster (WARNING: destroys all data)
    list-versions       List available Materialize versions
    status              Show current deployment status

Options:
    -v, --version VERSION        Materialize version (default: ${DEFAULT_VERSION})
    -o, --operator-version VER   Operator version (default: same as --version)
    -l, --license-key FILE       Path to file containing license key
    -c, --cluster NAME           k3d cluster name (default: mzk3-cluster)
    -n, --namespace NAMESPACE    Operator namespace (default: materialize)
    -r, --release-name NAME      Helm release name (default: my-materialize-operator)
    -i, --instance-ns NAMESPACE  Materialize instance namespace (default: materialize-environment)
    -f, --values-file FILE       Path to values file (default: sample-values-k3s.yaml)
    -y, --yes                    Skip confirmation prompts
    --create-cluster             Create a new k3d cluster before installing (install only)
    --force                      Force operation (upgrade: forceRollout; install: bypass cluster check)
    --install-dashboards         Install Prometheus & Grafana monitoring stack
    -h, --help                   Show this help message

Environment Variables (used as defaults):
    MZ_VERSION          - Materialize version
    MZ_OPERATOR_VERSION - Operator version
    MZ_LICENSE_KEY      - Path to license key file
    K3D_CLUSTER_NAME    - k3d cluster name
    MZ_NAMESPACE        - Operator namespace
    MZ_RELEASE_NAME     - Helm release name
    MZ_INSTANCE_NS      - Materialize instance namespace
    MZ_VALUES_FILE      - Path to values file

Examples:
    $(basename "$0") create-cluster
    $(basename "$0") create-cluster -c my-cluster
    $(basename "$0") install --create-cluster
    $(basename "$0") install -c my-cluster
    $(basename "$0") install -v v26.5.0 -l /path/to/license.key
    $(basename "$0") install --install-dashboards
    $(basename "$0") install --force              # Install on any cluster (bypass safety check)
    $(basename "$0") upgrade -v v26.5.0
    $(basename "$0") upgrade -v v26.5.0 --yes
    $(basename "$0") upgrade -v v26.5.0 --force
    $(basename "$0") reset
    $(basename "$0") reset --yes
    $(basename "$0") list-versions
    $(basename "$0") status

Cluster Management:
    This script only installs on k3d clusters it created (identified by label).
    Use --create-cluster with install, or create-cluster command first.
    Use --force to bypass this check and install on any cluster.
EOF
    exit 0
}

# Check prerequisites
check_prerequisites() {
    log_info "Checking prerequisites..."

    if ! command -v kubectl &> /dev/null; then
        log_error "kubectl is not installed. Please install kubectl first."
        exit 1
    fi

    if ! command -v helm &> /dev/null; then
        log_error "Helm is not installed. Please install Helm 3.x first."
        exit 1
    fi

    if ! command -v curl &> /dev/null; then
        log_error "curl is not installed. Please install curl first."
        exit 1
    fi

    if ! kubectl cluster-info &> /dev/null; then
        log_error "Cannot connect to Kubernetes cluster. Please ensure K3s is running and kubectl is configured."
        exit 1
    fi

    log_info "All prerequisites met."
}

# Verify K3s cluster
verify_k3s_cluster() {
    log_info "Verifying K3s cluster..."

    if kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}' 2>/dev/null | grep -q "k3s"; then
        log_info "K3s cluster detected."
    else
        log_warn "This may not be a K3s cluster. Proceeding anyway..."
    fi

    kubectl get nodes
}

# List k3d clusters created by this script
list_mzk3_clusters() {
    if ! command -v k3d &> /dev/null; then
        return 1
    fi
    # Get clusters and filter by label
    k3d cluster list -o json 2>/dev/null | \
        jq -r '.[] | select(.serversRunning > 0) | .name' 2>/dev/null | \
        while read -r cluster; do
            # Check if cluster has our label by inspecting the node labels
            if docker inspect "k3d-${cluster}-server-0" 2>/dev/null | jq -e '.[0].Config.Labels["created-by"] == "mzk3"' &>/dev/null; then
                echo "${cluster}"
            fi
        done
}

# Check if a cluster was created by this script
is_mzk3_cluster() {
    local cluster_name="$1"
    if ! command -v k3d &> /dev/null; then
        return 1
    fi
    # Check the docker container label
    if docker inspect "k3d-${cluster_name}-server-0" 2>/dev/null | jq -e '.[0].Config.Labels["created-by"] == "mzk3"' &>/dev/null; then
        return 0
    fi
    return 1
}

# Create a k3d cluster with mzk3 label (idempotent)
create_cluster() {
    local cluster_name="$1"

    # Check for k3d
    if ! command -v k3d &> /dev/null; then
        log_error "k3d is not installed. Please install k3d first."
        log_error "See: https://k3d.io/"
        exit 1
    fi

    # Check if cluster already exists
    if k3d cluster list 2>/dev/null | grep -q "^${cluster_name} "; then
        # Cluster exists - check if it's an mzk3 cluster
        if is_mzk3_cluster "${cluster_name}"; then
            log_info "Cluster '${cluster_name}' already exists and is an mzk3 cluster. Using it."
            return 0
        else
            log_error "Cluster '${cluster_name}' already exists but was not created by mzk3."
            log_error "Use a different name with -c/--cluster, delete the existing cluster, or use --force."
            exit 1
        fi
    fi

    log_step "Creating k3d cluster '${cluster_name}'..."
    k3d cluster create "${cluster_name}" --runtime-label "${MZK3_LABEL}@server:*"

    # Wait for cluster to be ready
    log_info "Waiting for cluster to be ready..."
    sleep 5

    # Wait for node to be ready
    local retries=30
    while [[ $retries -gt 0 ]]; do
        if kubectl get nodes 2>/dev/null | grep -q " Ready"; then
            break
        fi
        log_info "Waiting for node... (${retries} retries left)"
        sleep 5
        retries=$((retries - 1))
    done

    if [[ $retries -eq 0 ]]; then
        log_error "Timeout waiting for k3d node to be ready."
        exit 1
    fi

    log_info "Cluster '${cluster_name}' created successfully."
    kubectl get nodes
}

# List available versions
cmd_list_versions() {
    log_info "Updating Helm repository..."
    helm repo add materialize https://materializeinc.github.io/materialize 2>/dev/null || true
    helm repo update materialize
    echo ""
    log_info "Available Materialize Operator versions:"
    helm search repo materialize/materialize-operator --versions | head -20
}

# Show status
cmd_status() {
    check_prerequisites

    echo ""
    log_info "=== Helm Releases ==="
    helm list -n "${NAMESPACE}" 2>/dev/null || echo "No releases found in ${NAMESPACE}"

    echo ""
    log_info "=== Materialize Instances ==="
    kubectl get materialize -A 2>/dev/null || echo "No Materialize instances found"

    echo ""
    log_info "=== Pods in ${INSTANCE_NS} ==="
    kubectl get pods -n "${INSTANCE_NS}" 2>/dev/null || echo "No pods found in ${INSTANCE_NS}"

    echo ""
    log_info "=== Services in ${INSTANCE_NS} ==="
    kubectl get svc -n "${INSTANCE_NS}" 2>/dev/null || echo "No services found in ${INSTANCE_NS}"
}

# Install Prometheus and Grafana monitoring stack
install_monitoring() {
    log_step "Installing Prometheus & Grafana monitoring stack..."

    # Add Helm repo
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
    helm repo update prometheus-community

    # Create monitoring namespace
    kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

    # Download Materialize Prometheus scrape config
    log_info "Downloading Materialize Prometheus configuration..."
    download_file "https://raw.githubusercontent.com/MaterializeInc/materialize/main/doc/user/data/self_managed/monitoring/prometheus.yml" "mz-prometheus-scrape.yml" || exit 1

    # Create a simple Materialize dashboard optimized for k3d/local environments
    log_info "Creating Materialize dashboard..."
    cat > mz-dashboard.json <<'DASHBOARD_EOF'
{
  "annotations": {
    "list": []
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "panels": [
    {
      "collapsed": false,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
      "id": 100,
      "panels": [],
      "title": "Resource Utilization",
      "type": "row"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 80}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 1},
      "id": 1,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{namespace=~\"materialize.*\", pod=~\".*mz.*\"}[5m]))",
          "legendFormat": "{{pod}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "CPU Usage by Pod",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 80}]},
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 1},
      "id": 2,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum by (pod) (container_memory_working_set_bytes{namespace=~\"materialize.*\", pod=~\".*mz.*\"})",
          "legendFormat": "{{pod}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Memory Usage by Pod",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 9},
      "id": 101,
      "panels": [],
      "title": "Freshness & Lag",
      "type": "row"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 1}, {"color": "red", "value": 10}]},
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {"h": 4, "w": 6, "x": 0, "y": 10},
      "id": 3,
      "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showPercentChange": false, "textMode": "auto", "wideLayout": true},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "max(mz_dataflow_wallclock_lag_seconds{quantile=\"1\"})",
          "legendFormat": "Max Lag",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Max Wallclock Lag",
      "type": "stat"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.5}, {"color": "red", "value": 5}]},
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {"h": 4, "w": 6, "x": 6, "y": 10},
      "id": 4,
      "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showPercentChange": false, "textMode": "auto", "wideLayout": true},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "avg(mz_dataflow_wallclock_lag_seconds{quantile=\"0.5\"})",
          "legendFormat": "Median Lag",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Median Wallclock Lag (p50)",
      "type": "stat"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 4, "w": 6, "x": 12, "y": 10},
      "id": 5,
      "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showPercentChange": false, "textMode": "auto", "wideLayout": true},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "mz_active_sessions",
          "legendFormat": "Sessions",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Active Sessions",
      "type": "stat"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 4, "w": 6, "x": 18, "y": 10},
      "id": 6,
      "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showPercentChange": false, "textMode": "auto", "wideLayout": true},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "mz_active_subscribes",
          "legendFormat": "Subscribes",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Active Subscribes",
      "type": "stat"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14},
      "id": 7,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "topk(10, max by (collection_id) (mz_dataflow_wallclock_lag_seconds{quantile=\"1\"}))",
          "legendFormat": "{{collection_id}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Wallclock Lag by Collection (Top 10, p100)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14},
      "id": 8,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "max(mz_dataflow_wallclock_lag_seconds{quantile=\"1\"})",
          "legendFormat": "p100 (max)",
          "range": true,
          "refId": "A"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "avg(mz_dataflow_wallclock_lag_seconds{quantile=\"0.99\"})",
          "legendFormat": "p99",
          "range": true,
          "refId": "B"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "avg(mz_dataflow_wallclock_lag_seconds{quantile=\"0.5\"})",
          "legendFormat": "p50",
          "range": true,
          "refId": "C"
        }
      ],
      "title": "Wallclock Lag Distribution Over Time",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 22},
      "id": 102,
      "panels": [],
      "title": "Dataflow Performance",
      "type": "row"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 23},
      "id": 9,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum(mz_arrangement_size_bytes)",
          "legendFormat": "Total Arrangement Size",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Total Arrangement Size",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 23},
      "id": 10,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum(mz_arrangement_record_count)",
          "legendFormat": "Total Record Count",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Total Arrangement Record Count",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 31},
      "id": 103,
      "panels": [],
      "title": "Pod Health",
      "type": "row"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "stepAfter", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
      "id": 11,
      "options": {"legend": {"calcs": ["last", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum by (pod) (kube_pod_container_status_restarts_total{namespace=~\"materialize.*\"})",
          "legendFormat": "{{pod}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Pod Restarts (Total)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "stepAfter", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "auto", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
          "mappings": [],
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]},
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
      "id": 12,
      "options": {"legend": {"calcs": ["last", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "editorMode": "code",
          "expr": "sum by (pod, container) (kube_pod_container_status_last_terminated_reason{namespace=~\"materialize.*\", reason=\"OOMKilled\"})",
          "legendFormat": "{{pod}}/{{container}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "OOM Killed Containers",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "tags": ["materialize"],
  "templating": {"list": []},
  "time": {"from": "now-1h", "to": "now"},
  "timepicker": {},
  "timezone": "browser",
  "title": "Materialize Overview",
  "uid": "materialize-overview",
  "version": 1,
  "weekStart": ""
}
DASHBOARD_EOF

    # Create values file for kube-prometheus-stack with full Materialize scrape config
    cat > monitoring-values.yaml <<'EOF'
prometheus:
  prometheusSpec:
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    additionalScrapeConfigs:
      # Standard pod scraping (environmentd, balancerd)
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: 'true'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
          - action: replace
            regex: '(https?)'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: '(.+)'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_path
            target_label: __metrics_path__
          - action: replace
            regex: '([^:]+)(?::\d+)?;(\d+)'
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_pod_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: '__meta_kubernetes_pod_annotation_prometheus_io_param_(.+)'
            replacement: __param_$1
          - action: labelmap
            regex: '__meta_kubernetes_pod_label_(.+)'
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: kubernetes_namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: kubernetes_pod_name
          - action: drop
            regex: 'Pending|Succeeded|Failed|Completed'
            source_labels:
              - __meta_kubernetes_pod_phase
      # Clusterd compute metrics
      - job_name: kubernetes-pods-mz-compute
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: 'true'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
          - action: replace
            regex: '(https?)'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: '(.+)'
            source_labels:
              - __meta_kubernetes_pod_annotation_materialize_prometheus_io_mz_compute_path
            target_label: __metrics_path__
          - action: replace
            regex: '([^:]+)(?::\d+)?;(\d+)'
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_pod_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: '__meta_kubernetes_pod_annotation_prometheus_io_param_(.+)'
            replacement: __param_$1
          - action: labelmap
            regex: '__meta_kubernetes_pod_label_(.+)'
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: kubernetes_namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: kubernetes_pod_name
          - action: drop
            regex: 'Pending|Succeeded|Failed|Completed'
            source_labels:
              - __meta_kubernetes_pod_phase
      # Clusterd storage metrics
      - job_name: kubernetes-pods-mz-storage
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: 'true'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
          - action: replace
            regex: '(https?)'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: '(.+)'
            source_labels:
              - __meta_kubernetes_pod_annotation_materialize_prometheus_io_mz_storage_path
            target_label: __metrics_path__
          - action: replace
            regex: '([^:]+)(?::\d+)?;(\d+)'
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_pod_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: '__meta_kubernetes_pod_annotation_prometheus_io_param_(.+)'
            replacement: __param_$1
          - action: labelmap
            regex: '__meta_kubernetes_pod_label_(.+)'
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: kubernetes_namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: kubernetes_pod_name
          - action: drop
            regex: 'Pending|Succeeded|Failed|Completed'
            source_labels:
              - __meta_kubernetes_pod_phase
      # Usage metrics
      - job_name: kubernetes-pods-mz-usage
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: 'true'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
          - action: replace
            regex: '(https?)'
            source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
            target_label: __scheme__
          - action: replace
            regex: '(.+)'
            source_labels:
              - __meta_kubernetes_pod_annotation_materialize_prometheus_io_mz_usage_path
            target_label: __metrics_path__
          - action: replace
            regex: '([^:]+)(?::\d+)?;(\d+)'
            replacement: $1:$2
            source_labels:
              - __address__
              - __meta_kubernetes_pod_annotation_prometheus_io_port
            target_label: __address__
          - action: labelmap
            regex: '__meta_kubernetes_pod_annotation_prometheus_io_param_(.+)'
            replacement: __param_$1
          - action: labelmap
            regex: '__meta_kubernetes_pod_label_(.+)'
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: kubernetes_namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: kubernetes_pod_name
          - action: drop
            regex: 'Pending|Succeeded|Failed|Completed'
            source_labels:
              - __meta_kubernetes_pod_phase
      # NOTE: kubelet-cadvisor metrics (container_spec_memory_limit_bytes, etc.)
      # are NOT available on k3d/kind running on macOS due to nested container
      # virtualization. These metrics work on native Linux deployments.
grafana:
  enabled: true
  adminPassword: admin
  service:
    type: ClusterIP
  persistence:
    enabled: false
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: monitoring
alertmanager:
  enabled: false
EOF

    # Install kube-prometheus-stack
    log_info "Installing kube-prometheus-stack..."
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
        --namespace monitoring \
        -f monitoring-values.yaml \
        --set prometheus.prometheusSpec.scrapeInterval=30s \
        --wait --timeout 10m

    # Create ConfigMap for Materialize dashboard (Grafana sidecar will pick this up)
    log_info "Provisioning Materialize dashboard..."

    kubectl create configmap mz-dashboard \
        --from-file=mz-dashboard.json \
        --namespace monitoring \
        --dry-run=client -o yaml | kubectl apply -f -
    kubectl label configmap mz-dashboard grafana_dashboard=1 --namespace monitoring --overwrite

    # Restart Grafana to pick up new dashboards
    log_info "Restarting Grafana to load dashboards..."
    kubectl rollout restart deployment prometheus-grafana -n monitoring
    kubectl rollout status deployment prometheus-grafana -n monitoring --timeout=120s

    log_info "Monitoring stack installed successfully."
    echo ""
    log_info "Access Grafana:"
    log_info "  kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80"
    log_info "  Open http://localhost:3000 (admin/admin)"
    echo ""
    log_info "Materialize Dashboard: 'Materialize Overview'"
    log_info "  - CPU and Memory usage by pod"
    log_info "  - Wallclock lag (freshness) stats and graphs"
    log_info "  - Active sessions and subscribes"
    log_info "  - Arrangement size and record counts"
    echo ""
    log_info "Access Prometheus:"
    log_info "  kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090"
    log_info "  Open http://localhost:9090"
    echo ""
}

# Create a new k3d cluster
cmd_create_cluster() {
    create_cluster "${K3D_CLUSTER_NAME}"

    echo ""
    log_info "=============================================="
    log_info " K3d Cluster Created!"
    log_info "=============================================="
    echo ""
    log_info "Cluster '${K3D_CLUSTER_NAME}' is ready for Materialize installation."
    log_info ""
    log_info "To install Materialize:"
    log_info "  $(basename "$0") install -c ${K3D_CLUSTER_NAME}"
    log_info ""
    log_info "Or install with dashboards:"
    log_info "  $(basename "$0") install -c ${K3D_CLUSTER_NAME} --install-dashboards"
    echo ""
}

# Reset K3s cluster (via k3d)
cmd_reset() {
    # Check for k3d
    if ! command -v k3d &> /dev/null; then
        log_error "k3d is not installed. Please install k3d first."
        log_error "See: https://k3d.io/"
        exit 1
    fi

    echo ""
    log_warn "=============================================="
    log_warn " WARNING: This will destroy the K3s cluster!"
    log_warn "=============================================="
    log_warn ""
    log_warn "This operation will:"
    log_warn "  - Delete the k3d cluster '${K3D_CLUSTER_NAME}'"
    log_warn "  - DELETE ALL DATA including Materialize databases"
    log_warn "  - Remove all Kubernetes resources"
    log_warn "  - Create a fresh k3d cluster"
    log_warn ""
    log_warn "This action is IRREVERSIBLE."
    echo ""

    if [[ "${SKIP_CONFIRM}" != "true" ]]; then
        read -p "Are you sure you want to reset the cluster? Type 'yes' to confirm: " -r
        echo ""
        if [[ ! "${REPLY}" == "yes" ]]; then
            log_info "Reset cancelled."
            exit 0
        fi
    fi

    # Delete existing cluster
    log_step "Step 1: Deleting k3d cluster '${K3D_CLUSTER_NAME}'..."
    k3d cluster delete "${K3D_CLUSTER_NAME}" 2>/dev/null || log_warn "Cluster '${K3D_CLUSTER_NAME}' not found or already deleted."

    # Create new cluster with mzk3 label
    log_step "Step 2: Creating new k3d cluster '${K3D_CLUSTER_NAME}'..."
    k3d cluster create "${K3D_CLUSTER_NAME}" --runtime-label "${MZK3_LABEL}@server:*"

    # Wait for cluster to be ready
    log_step "Step 3: Waiting for cluster to be ready..."
    sleep 5

    # Wait for node to be ready
    log_info "Waiting for node to be ready..."
    local retries=30
    while [[ $retries -gt 0 ]]; do
        if kubectl get nodes 2>/dev/null | grep -q " Ready"; then
            break
        fi
        log_info "Waiting for node... (${retries} retries left)"
        sleep 5
        retries=$((retries - 1))
    done

    if [[ $retries -eq 0 ]]; then
        log_error "Timeout waiting for k3d node to be ready."
        exit 1
    fi

    kubectl get nodes

    echo ""
    log_info "=============================================="
    log_info " K3d Cluster Reset Complete!"
    log_info "=============================================="
    echo ""
    log_info "The cluster has been reset to a fresh state."
    log_info ""
    log_info "To install Materialize:"
    log_info "  $(basename "$0") install"
    log_info ""
    log_info "To install with a specific version:"
    log_info "  $(basename "$0") install -v ${VERSION}"
    echo ""
}

# Install Materialize
cmd_install() {
    # Create cluster if requested
    if [[ "${CREATE_CLUSTER}" == "true" ]]; then
        create_cluster "${K3D_CLUSTER_NAME}"
    fi

    check_prerequisites
    verify_k3s_cluster

    # Verify cluster was created by mzk3 (unless --force is used)
    if [[ "${FORCE_ROLLOUT}" != "true" ]]; then
        if ! is_mzk3_cluster "${K3D_CLUSTER_NAME}"; then
            echo ""
            log_error "Cluster '${K3D_CLUSTER_NAME}' was not created by mzk3."
            log_error ""
            log_error "This script only installs on clusters it created to prevent"
            log_error "accidental modifications to existing clusters."
            echo ""

            # List available mzk3 clusters
            local mzk3_clusters
            mzk3_clusters=$(list_mzk3_clusters)
            if [[ -n "${mzk3_clusters}" ]]; then
                log_info "Available mzk3 clusters:"
                echo "${mzk3_clusters}" | while read -r c; do
                    log_info "  - ${c}"
                done
                echo ""
                log_info "Use one of these clusters with: $(basename "$0") install -c <cluster-name>"
            else
                log_info "No mzk3-created clusters found."
            fi

            echo ""
            log_info "Options:"
            log_info "  1. Create a new cluster:  $(basename "$0") install --create-cluster"
            log_info "  2. Use existing cluster:  $(basename "$0") install --force  (bypasses this check)"
            echo ""
            exit 1
        fi
    else
        if ! is_mzk3_cluster "${K3D_CLUSTER_NAME}"; then
            log_warn "Cluster '${K3D_CLUSTER_NAME}' was not created by mzk3."
            log_warn "Proceeding anyway due to --force flag."
        fi
    fi

    log_info "Using Materialize version: ${VERSION}"
    log_info "Using Operator version: ${OPERATOR_VERSION}"

    # Label nodes for Materialize workloads
    log_step "Labeling nodes for Materialize workloads..."
    for node in $(kubectl get nodes --no-headers -o custom-columns=":metadata.name"); do
        log_info "Labeling node: $node"
        kubectl label node "$node" materialize.cloud/swap=true --overwrite || true
        kubectl label node "$node" workload=materialize-instance --overwrite || true
    done

    # Download configuration files
    log_step "Downloading Materialize configuration files..."
    download_file "https://raw.githubusercontent.com/MaterializeInc/materialize/${OPERATOR_VERSION}/misc/helm-charts/operator/values.yaml" "sample-values-k3s.yaml" || exit 1
    download_file "https://raw.githubusercontent.com/MaterializeInc/materialize/${VERSION}/misc/helm-charts/testing/postgres.yaml" "sample-postgres.yaml" || exit 1
    download_file "https://raw.githubusercontent.com/MaterializeInc/materialize/${VERSION}/misc/helm-charts/testing/minio.yaml" "sample-minio.yaml" || exit 1
    download_file "https://raw.githubusercontent.com/MaterializeInc/materialize/${VERSION}/misc/helm-charts/testing/materialize.yaml" "sample-materialize.yaml" || exit 1

    log_info "All configuration files downloaded successfully."

    # Patch values for k3s
    log_info "Patching configuration for K3s..."
    sed -i.bak 's/region: "kind"/region: "k3s"/' sample-values-k3s.yaml
    rm -f sample-values-k3s.yaml.bak

    # Patch the Materialize CR to use the specified version
    log_info "Patching Materialize CR with version ${VERSION}..."
    sed -i.bak "s|environmentdImageRef: materialize/environmentd:v[0-9.]*|environmentdImageRef: materialize/environmentd:${VERSION}|" sample-materialize.yaml
    rm -f sample-materialize.yaml.bak

    # Patch license key if provided
    if [[ -n "${LICENSE_KEY_FILE}" ]]; then
        if [[ -f "${LICENSE_KEY_FILE}" ]]; then
            log_info "Reading license key from file: ${LICENSE_KEY_FILE}"
            LICENSE_KEY_VALUE=$(cat "${LICENSE_KEY_FILE}" | tr -d '\n')
            log_info "Patching license key into sample-materialize.yaml..."
            sed -i.bak "s|license_key: \"\"|license_key: \"${LICENSE_KEY_VALUE}\"|" sample-materialize.yaml
            rm -f sample-materialize.yaml.bak
            log_info "License key configured successfully."
        else
            log_error "License key file does not exist: ${LICENSE_KEY_FILE}"
            exit 1
        fi
    else
        log_warn "No license key provided. Materialize will run without a license key."
    fi

    # Add/update Helm repositories
    log_step "Setting up Helm repositories..."
    helm repo add materialize https://materializeinc.github.io/materialize || true
    helm repo update materialize

    helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/ || true
    helm repo update metrics-server

    # Create materialize namespace
    log_step "Creating materialize namespace..."
    kubectl create namespace materialize --dry-run=client -o yaml | kubectl apply -f -

    # Deploy PostgreSQL backend
    log_step "Deploying PostgreSQL backend..."
    kubectl apply -f sample-postgres.yaml

    # Deploy MinIO (S3-compatible storage)
    log_step "Deploying MinIO storage backend..."
    kubectl apply -f sample-minio.yaml

    # Check if metrics-server is already installed
    log_step "Checking for metrics-server..."
    if kubectl get deployment metrics-server -n kube-system &> /dev/null; then
        log_info "metrics-server is already installed in the cluster."
    else
        log_info "Installing metrics-server..."
        helm install metrics-server metrics-server/metrics-server \
            --namespace kube-system \
            --set args="{--kubelet-insecure-tls,--kubelet-preferred-address-types=InternalIP\,Hostname\,ExternalIP}" \
            --wait || log_warn "metrics-server installation failed. Pod metrics may not be available."
    fi

    # Wait for backends to be ready
    log_step "Waiting for backends to be ready..."
    kubectl wait --for=condition=available --timeout=300s deployment/postgres -n materialize || true
    kubectl wait --for=condition=available --timeout=300s deployment/minio -n materialize || true

    # Install Materialize Operator (skip if already at correct version)
    CURRENT_OPERATOR_VERSION=$(helm list -n "${NAMESPACE}" -o json 2>/dev/null | jq -r ".[] | select(.name==\"${RELEASE_NAME}\") | .chart" | sed 's/materialize-operator-//' || echo "")
    if [[ "${CURRENT_OPERATOR_VERSION}" == "${OPERATOR_VERSION}" ]]; then
        log_info "Materialize Operator already at version ${OPERATOR_VERSION}. Skipping."
    else
        log_step "Installing Materialize Operator..."
        helm upgrade --install "${RELEASE_NAME}" materialize/materialize-operator \
            --namespace="${NAMESPACE}" \
            --create-namespace \
            --version "${OPERATOR_VERSION}" \
            --set observability.enabled=true \
            --set observability.podMetrics.enabled=true \
            --set observability.prometheus.scrapeAnnotations.enabled=true \
            --set operator.cloudProvider.region=k3s \
            -f sample-values-k3s.yaml \
            --wait

        log_info "Waiting for Materialize Operator to be ready..."
        kubectl wait --for=condition=available --timeout=300s deployment/"${RELEASE_NAME}" -n "${NAMESPACE}" || true
    fi

    # Deploy Materialize instance (skip if already at correct version)
    CURRENT_MZ_IMAGE=$(kubectl get materialize -n "${INSTANCE_NS}" -o jsonpath='{.items[0].spec.environmentdImageRef}' 2>/dev/null || echo "")
    TARGET_MZ_IMAGE="materialize/environmentd:${VERSION}"
    if [[ "${CURRENT_MZ_IMAGE}" == "${TARGET_MZ_IMAGE}" ]]; then
        log_info "Materialize instance already at version ${VERSION}. Skipping."
    else
        log_step "Deploying Materialize instance..."
        kubectl apply -f sample-materialize.yaml

        log_info "Waiting for Materialize instance to be ready..."
        log_info "(This may take a few minutes as pods are created...)"

        sleep 10
        kubectl wait --for=condition=available --timeout=600s deployment -l app.kubernetes.io/component=environmentd -n "${INSTANCE_NS}" 2>/dev/null || \
            log_warn "Timeout waiting for environmentd. Check status with: kubectl get pods -n ${INSTANCE_NS}"
    fi

    # Install dashboards if enabled
    if [[ "${INSTALL_DASHBOARDS}" == "true" ]]; then
        install_monitoring
    fi

    print_success_install
}

# Upgrade Materialize
cmd_upgrade() {
    check_prerequisites

    # Check if uuidgen is available
    if ! command -v uuidgen &> /dev/null; then
        log_error "uuidgen is not installed. Please install it first."
        exit 1
    fi

    log_info "Target Materialize version: ${VERSION}"
    log_info "Target Operator version: ${OPERATOR_VERSION}"

    # Update Helm repository
    log_step "Step 1: Updating Helm repository..."
    helm repo update materialize

    log_info "Available versions:"
    helm search repo materialize/materialize-operator --versions | head -10

    # Get current deployment info
    log_step "Step 2: Checking current deployment..."
    echo ""
    log_info "Current Helm releases in ${NAMESPACE} namespace:"
    helm list -n "${NAMESPACE}"

    CURRENT_VERSION=$(helm list -n "${NAMESPACE}" -o json | grep -o '"app_version":"[^"]*"' | head -1 | cut -d'"' -f4)
    log_info "Current operator app version: ${CURRENT_VERSION:-unknown}"

    log_info "Current Materialize instances:"
    kubectl get materialize -A 2>/dev/null || log_warn "No Materialize instances found."

    # Get instance name
    MZ_INSTANCE_NAME=$(kubectl get materialize -n "${INSTANCE_NS}" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
    if [[ -z "${MZ_INSTANCE_NAME}" ]]; then
        log_warn "No Materialize instance found in ${INSTANCE_NS}. Will only upgrade the operator."
    fi

    echo ""
    log_warn "This will upgrade Materialize to version ${VERSION}"
    log_warn "The upgrade process will:"
    log_warn "  1. Upgrade the Materialize Operator"
    if [[ -n "${MZ_INSTANCE_NAME}" ]]; then
        log_warn "  2. Update the Materialize instance image"
        log_warn "  3. Trigger a rollout (may cause brief service interruption)"
    fi
    echo ""

    if [[ "${SKIP_CONFIRM}" != "true" ]]; then
        read -p "Continue with upgrade? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Upgrade cancelled."
            exit 0
        fi
    fi

    # Upgrade the Materialize Operator
    log_step "Step 3: Upgrading Materialize Operator to ${OPERATOR_VERSION}..."

    if [[ -f "${VALUES_FILE}" ]]; then
        log_info "Using values file: ${VALUES_FILE}"
        helm upgrade "${RELEASE_NAME}" materialize/materialize-operator \
            -n "${NAMESPACE}" \
            --version "${OPERATOR_VERSION}" \
            --set observability.podMetrics.enabled=true \
            --set operator.cloudProvider.region=k3s \
            -f "${VALUES_FILE}" \
            --wait
    else
        log_warn "Values file not found: ${VALUES_FILE}. Upgrading without custom values."
        helm upgrade "${RELEASE_NAME}" materialize/materialize-operator \
            -n "${NAMESPACE}" \
            --version "${OPERATOR_VERSION}" \
            --set observability.podMetrics.enabled=true \
            --set operator.cloudProvider.region=k3s \
            --wait
    fi

    log_info "Waiting for operator to be ready..."
    kubectl wait --for=condition=available --timeout=300s deployment/"${RELEASE_NAME}" -n "${NAMESPACE}"
    log_info "Operator upgraded successfully."

    # Upgrade Materialize instance
    if [[ -n "${MZ_INSTANCE_NAME}" ]]; then
        log_step "Step 4: Upgrading Materialize instance ${MZ_INSTANCE_NAME}..."

        CURRENT_IMAGE=$(kubectl get materialize "${MZ_INSTANCE_NAME}" -n "${INSTANCE_NS}" -o jsonpath='{.spec.environmentdImageRef}' 2>/dev/null || echo "unknown")
        log_info "Current image: ${CURRENT_IMAGE}"
        log_info "Target image: materialize/environmentd:${VERSION}"

        log_info "Staging version change..."
        kubectl patch materialize "${MZ_INSTANCE_NAME}" \
            -n "${INSTANCE_NS}" \
            --type='merge' \
            -p "{\"spec\": {\"environmentdImageRef\": \"materialize/environmentd:${VERSION}\"}}"

        log_step "Step 5: Triggering rollout..."
        ROLLOUT_UUID=$(uuidgen)
        log_info "Rollout UUID: ${ROLLOUT_UUID}"

        if [[ "${FORCE_ROLLOUT}" == "true" ]]; then
            log_warn "Force rollout enabled - setting forceRollout"
            kubectl patch materialize "${MZ_INSTANCE_NAME}" \
                -n "${INSTANCE_NS}" \
                --type='merge' \
                -p "{\"spec\": {\"requestRollout\": \"${ROLLOUT_UUID}\", \"forceRollout\": \"${ROLLOUT_UUID}\"}}"
        else
            kubectl patch materialize "${MZ_INSTANCE_NAME}" \
                -n "${INSTANCE_NS}" \
                --type='merge' \
                -p "{\"spec\": {\"requestRollout\": \"${ROLLOUT_UUID}\"}}"
        fi

        log_info "Rollout triggered. Waiting for new pods to be ready..."
        log_info "(This may take several minutes...)"

        sleep 10
        kubectl wait --for=condition=available --timeout=600s deployment -l app.kubernetes.io/component=environmentd -n "${INSTANCE_NS}" 2>/dev/null || \
            log_warn "Timeout waiting for environmentd. Check status manually."
    fi

    print_success_upgrade
}

print_success_install() {
    echo ""
    log_info "=============================================="
    log_info " Materialize Self-Managed Setup Complete!"
    log_info "=============================================="
    echo ""
    log_info "Check instance status:"
    log_info "  $(basename "$0") status"
    echo ""
    log_info "Access the console:"
    log_info "  MZ_CONSOLE=\$(kubectl -n ${INSTANCE_NS} get svc -o name | grep console)"
    log_info "  kubectl port-forward \$MZ_CONSOLE 8080:8080 -n ${INSTANCE_NS}"
    echo ""
    log_info "Connect via psql:"
    log_info "  MZ_BALANCER=\$(kubectl -n ${INSTANCE_NS} get svc -o name | grep balancerd)"
    log_info "  kubectl port-forward \$MZ_BALANCER 6875:6875 -n ${INSTANCE_NS}"
    log_info "  psql -h localhost -p 6875 -U mz_system materialize"
    echo ""
    log_info "Configuration files saved:"
    log_info "  - sample-values-k3s.yaml  (Helm values for operator)"
    log_info "  - sample-postgres.yaml    (PostgreSQL backend)"
    log_info "  - sample-minio.yaml       (MinIO storage)"
    log_info "  - sample-materialize.yaml (Materialize instance CRD)"
    echo ""

    if [[ "${INSTALL_DASHBOARDS}" == "true" ]]; then
        log_info "Monitoring:"
        log_info "  Grafana:    kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80"
        log_info "              Open http://localhost:3000 (admin/admin)"
        log_info "  Prometheus: kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090"
        log_info "              Open http://localhost:9090"
        log_info "  Dashboards: Environment Overview, Freshness Overview (pre-loaded)"
        echo ""
    fi
}

print_success_upgrade() {
    echo ""
    log_info "=============================================="
    log_info " Materialize Upgrade Complete!"
    log_info "=============================================="
    echo ""
    log_info "Verify the upgrade:"
    log_info "  $(basename "$0") status"
    echo ""
}

# Parse command
COMMAND=""
if [[ $# -gt 0 && ! "$1" =~ ^- ]]; then
    COMMAND="$1"
    shift
fi

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--version)
            VERSION="$2"
            shift 2
            ;;
        -o|--operator-version)
            OPERATOR_VERSION="$2"
            shift 2
            ;;
        -l|--license-key)
            LICENSE_KEY_FILE="$2"
            shift 2
            ;;
        -c|--cluster)
            K3D_CLUSTER_NAME="$2"
            shift 2
            ;;
        -n|--namespace)
            NAMESPACE="$2"
            shift 2
            ;;
        -r|--release-name)
            RELEASE_NAME="$2"
            shift 2
            ;;
        -i|--instance-ns)
            INSTANCE_NS="$2"
            shift 2
            ;;
        -f|--values-file)
            VALUES_FILE="$2"
            shift 2
            ;;
        -y|--yes)
            SKIP_CONFIRM="true"
            shift
            ;;
        --force)
            FORCE_ROLLOUT="true"
            shift
            ;;
        --install-dashboards)
            INSTALL_DASHBOARDS="true"
            shift
            ;;
        --create-cluster)
            CREATE_CLUSTER="true"
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            ;;
    esac
done

# Set operator version to match version if not specified
OPERATOR_VERSION="${OPERATOR_VERSION:-$VERSION}"

# Execute command
case "${COMMAND}" in
    install)
        cmd_install
        ;;
    upgrade)
        cmd_upgrade
        ;;
    reset)
        cmd_reset
        ;;
    create-cluster)
        cmd_create_cluster
        ;;
    list-versions)
        cmd_list_versions
        ;;
    status)
        cmd_status
        ;;
    "")
        log_error "No command specified."
        usage
        ;;
    *)
        log_error "Unknown command: ${COMMAND}"
        usage
        ;;
esac
